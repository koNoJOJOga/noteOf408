# 处理器

## 多周期处理器

### 逻辑单元

&emsp;&emsp;&ensp;时钟信号长度的确定：下图描述了一个组合逻辑单元及与其相连的两个状态单元。组合逻辑单元的操作在一个时钟周期内完成，所有信号在一个时钟周期内从状态单元1经组合逻辑到达状态单元2，**信号到达状态单元2所需的时间决定了时钟周期的长度**。

<div style=" margin: 0 auto; max-width: 40%;">
<img src="image.png" alt="Alt text" style="margin-top: 0; margin-bottom: 10px;" align="center">
</div>

### 多周期处理器

&emsp;&emsp;&ensp;在考试中，多周期处理器往往采用单总线的冯诺依曼结构。以指令ADD R0，[R1]为例：多周期处理器中每个节拍需要一个时钟周期。

![Alt text](image-1.png)

## 单周期处理器

&emsp;&emsp;&ensp;单周期处理器：通俗的说，就是该处理器一执行完任何一条指令的时间为1个时钟周期。
&emsp;&emsp;&ensp;R型指令:Add r1 r2 r3
&emsp;&emsp;&ensp;I型指令:Lw r3 r4 imm16 
&emsp;&emsp;&ensp;以上两条指令的指令周期均为1个时钟周期。
&emsp;&emsp;&ensp;由于单周期处理器访存指令和非访存指令的指令周期均为1个时钟周期，因此单周期处理器的时钟周期长度，由于包含访存时间的缘故会变得很长。
&emsp;&emsp;&ensp;按照时钟周期的定义，信号从一个状态单元经组合逻辑到达另一个状态单元。比如add r1，r2，r3指令，信号从第一个状态单元PC出发，最终的计算结果存入寄存器中。
&emsp;&emsp;&ensp;在取指令时，需要有一个访问指令Cache的操作。但受限于单周期处理器的整个数据通路中只可以存在**两个状态单元**，而指令地址从状态单元PC发出，因此单周期处理器的数据通路中只能在包含1个状态单元。若想满足 这个特点，**指令Cache就不能当作状态单元**。否则将无法满足单周期处理器的定义。
&emsp;&emsp;&ensp;为了解决这个问题。指令Cache被设计成只读的组合逻辑单元，CPU不能对指令Cache执行写操作，只能执行读 操作。

![Alt text](image-2.png)

&emsp;&emsp;&ensp;由于指令存储器是只读的，因此单周期处理器将其设计为无须控制信号的控制，只要给出指令地址，经过一定的“取数时间”后，指令被送出。
&emsp;&emsp;&ensp;在多周期处理器中，取值阶段根据PC的值将指令存入IR中。

![Alt text](image-3.png)

&emsp;&emsp;&ensp;在单周期处理器中，取指阶段并不会直接将指令输出。而是将指令译码后的控制信号，寄存器号以及立即数输出。

![Alt text](image-4.png)

![Alt text](image-5.png)

1. 指令与数据分离：对于单周期处理器，首先必须要具有独立的数据存储器和指令存储器。因为处理器在一个周期内只能操作每个部件一次，而在一个时钟周期内不可能对一个单端口存储器进行两次读写。 为了满足以上设计，计算机将指令Cache与数据Cache分离。当CPU需要指令时先访问指令Cache，需要数据时先访问数据Cache。
2. 数据通路的定义：通常将指令执行过程中数据所经过的路径，包括路径上的部件称为数据通路。ALU，通用寄存器，状态寄存器，cache，MMU，浮点运算逻辑，异常和中断处理逻辑等都是指令执行过程中数据流经的部件，都属于数据通路的一部分。数据通路由控制部件进行控制。控制部件根据每条指令功能的不同生成对数据通路的控制信号，并正确控制指令的执行流程。

![Alt text](image-6.png)

3. 关于不能使用单总线数据通路的原因：如果是单总线结构，比如ADD R1 R2 R3指令的执行阶段，R2和R3的数据需要分两次传，一次把R1的数据放入暂存器，一次是把暂存器的数据和R2通过ALU做加法。所以想要实现指令周期为一个时钟周期，至少需要有三根总线，分别接R1和R2以及ALU才能做到。

![Alt text](image-7.png)

4. 单周期处理器中的寄存器组：寄存器组在单周期处理器中，既允许执行读操作，也允许执行写操作。若执行读操作时，寄存器组当作组合逻辑部件。若需要写寄存器时，CPU给出写信号，寄存器组此时变成状态逻辑部件。
    寄存器组内部存在一个译码器，指令中的寄存器号会给到寄存器组中的译码器中。当译码器根据寄存器号，把对应的数据输出到BusA和BusB。

![Alt text](image-8.png)

5. 单周期处理器的控制信号: 由于单周期处理器的指令周期为一个时钟周期，所以单周期处理器在一个时钟周期内发出全部的控制信号， 并且执行全部的控制信号。所以单周期处理器，指令执行过程中控制信号不变。
    多周期处理器在译码阶段生成全部的控制信号，间址阶段和执行阶段的控制信号是发生变化的。
    在间址阶段的控制信号，在到了执行阶段后，其控制信号会发生变化。

![Alt text](image-9.png)

## 单周期处理器数据通路

&emsp;&emsp;&ensp;概述：由于单周期处理器在取指令时，并不会将指令取出，而是根据PC中的值，由取指部件经过一段取指时间后，直接输出指令的控制信号和需要的寄存器号，立即数等。所以后续对单周期处理器的讲解，主要围绕指令的执行过程的数据通路。

![Alt text](image-10.png)

1. R-型指令ADD Rd Rs Rt执行过程数据通路的设计：数据通路之中的组成部件有:寄存器组，ALU 由于R型指令要写回寄存器，所以指令要给出寄存器写(RegWr)信号。ALU控制信号(ALUctr)为add。
    ADD Rd Rs Rt指令执行过程的控制信号为：ALUctr:add，RegWr:1
    R-型指令的执行过程，数据在数据通路中的执行路径：Registers(Rs,Rt)→busA, busB→ALU→Registers(Rd)
    注意：寄存器堆的读操作，被设计成自动执行的操作，不需要其他的控制信号。但是写寄存器必须明确写控制信号。

![Alt text](image-11.png)

2. I-型指令ADDI Rt Rs imm16执行周期的数据通路设计：Rs + SignExt(imm16) -> Rt。
    数据通路之中的组成部件有：寄存器组，ALU，扩展器，两路选择器。
    由于指令addi需要将寄存器的值与立即数相加，所以需要在数据通路中添加一个扩展器从而进行符号扩展。并且，需要将扩展器和busB通过一个二路选择器相连。
    所以指令要给出寄存器写(RegWr)信号。ALU控制信号(ALUctr)为addu(addi)。扩展器信号(ExtOp)和二路选择器控制信号(ALUSrc)。
    ADDI Rt Rs imm16指令执行过程的控制信号为:ExtOp:1，ALUSrc:1，ALUctr:addi，RegDst:1，RegWr:1 数据在数据通路中的执行路径为：Registers(Rs)->busA,扩展器(imm16)→ALU(addi)→Registers(Rt)
    若在该数据通路上执行R型指令 ADD Rd Rs Rt ，其执行周期的控制信号为：ExtOp:0，ALUSrc:0，ALUctr:add， RegWr:1，RegDst:0
    数据在数据通路中的执行路径：Registers(Rs,Rt)→busA, busB→ALU→Registers(Rd)

![Alt text](image-12.png)

&emsp;&emsp;&ensp;单周期处理器的不足：单周期处理器的数据通路中，除了存在有效的数据流，还同时有无效的数据流。这是单周期处理器本身无法避 免的一个缺陷。比如I型指令是不需要提供rt寄存器的值输入到busB上，但由于在读寄存器组时为自动读取，并无控制信号。所以rt中的数据也会随之输送到busB上，这部分数据流就是无效数据流。

3. I-型指令Load Rt Rs imm16执行过程的数据通路：Mem[Rs + SignExt(imm16)] -> Rt Load指令的功能是将扩展后的立即数与源寄存器中的值相加得到有效地址，根据有效地址访问存储器将操作数读出并存入目的寄存器之中。
    为了实现Load指令，数据通路中需要新增的部件为一个数据存储器和一个二路选择器。其中数据存储器若执行读操作则仍然属于组合逻辑部件。若执行写操作，给出主存写信号(MemWr)，此时数据存储器变成状态逻辑部件。
    Load Rt Rs imm16指令功能的控制信号为：RegDst:1，ExtOp:1，ALUSrc:1，ALUctr:addi，MemWr:0，MemtoReg:1，RegWr:1 Load指令的数据在数据通路中的执行路径为：Registers(Rs)→ busA,扩展器(imm16)→ALU(addi)→数据存储器→Registers(Rt)
    虽然Load指令把busA中的数据和imm16在ALU中相加得到有效地址，但寄存器组在译码时仍会将rt译码并将其中的操作数送到busB，在busB上接一个引线将rt中的操作数送入数据寄存器。
    对于Load指令的数据通路，rt中的数据仍然会输出到busB之上。并且数据存储器对于ALU的输出，无论输出的是主存地址，还是两个数据的相加的值，数据存储器都会将其看作为主存地址，并将对应地址中的数据读出。

![Alt text](image-13.png)

&emsp;&emsp;&ensp;ADD Rd Rs Rt指令执行周期的控制信号为：ExtOp:0，ALUSrc:0，ALUctr:add，RegWr:1，RegDst:0，MemWr:0，MemtoReg:0
&emsp;&emsp;&ensp;ADD指令的执行周期，数据在数据通路中的执行路径Registers(Rs,Rt)→busA, busB→ALU→Registers(Rd)
&emsp;&emsp;&ensp;ADD指令的计算结果会从ALU输出。这个结果也会被当作成主存地址，并且数据存储器会将地址中的数读出。
&emsp;&emsp;&ensp;这个操作是十分危险，却无法避免的。因为数据寄存器的Adr并不知道ALU输出的是地址还是计算结果，只会机械的将所有ALU输出的值当作主存地址，并将对应的数据读出。
&emsp;&emsp;&ensp;ADDI Rt Rs imm16 指令执行周期的控制信号为:ExtOp:1，ALUSrc:1，ALUctr:addi，RegDst:1，RegWr:1， MemWr:0，MemtoReg:0
&emsp;&emsp;&ensp;ADDi指令的执行周期，数据在数据通路中的执行路径: Registers(Rs)->busA,扩展器(imm16)→ALU(addi)→Registers(Rt)
&emsp;&emsp;&ensp;I-型指令Store Rt Rs imm16执行过程的数据通路设计:Rt -> Mem[Rs + SignExt(imm16)] Store指令的功能是将扩展后的立即数与rs寄存器中的值相加得到主存地址，rt寄存器中的数据写入到主存地址 中。
&emsp;&emsp;&ensp;Store Rt Rs imm16指令执行周期的控制信号为: RegWr:0，RegDst:x，ExtOp:1，ALUSrc:1，ALUctr:addi，MemWr:1，MemtoReg:x 由于Store指令并没有写寄存器的操作，所以对于MemtoReg信号的取值，取1还是取0都不会影响结果。
&emsp;&emsp;&ensp;Store指令中rs寄存器的值会输入到busA，rt寄存器的值会输入busB，最终到达数据存储器。
&emsp;&emsp;&ensp;I-型分支指令beq Rs Rt imm16执行周期的数据通路设计:if(rs-rt = 0) pc = pc + imm16*4
&emsp;&emsp;&ensp;beq指令功能是对比rs和rt寄存器的值。如果相等则执行跳转操作。
&emsp;&emsp;&ensp;beq指令的数据通路实际上只用于比较rs和rt寄存器中值的大小即可。并根据branch信号来确定是否跳转。若 branch = 1则跳转。branch = 0则顺序执行。

![Alt text](image-14.png)

## 流水线处理器

### 指令流水线

&emsp;&emsp;&ensp;单周期处理器和多周期处理器都是采用串行方式，这种串行方式下，CPU总是在执行完一条指令后才取出下一条指令执行。这种串行方式没有充分利用执行部件的并行性，因而指令执行效率低。指令的执行也可以采用流水线方式将多条指令的执行相互重叠起来，以提高CPU执行指令的效率。采用这种方式的CPU称为指令流水线CPU。
&emsp;&emsp;&ensp;取指(IF)：从指令存储器或Cache中取指令。
&emsp;&emsp;&ensp;译码/读寄存器(ID)：操作控制器对指令进行译码，同时从根据寄存器号从寄存器组中取出操作数。
&emsp;&emsp;&ensp;执行/计算地址(EX)：执行运算操作或计算地址。
&emsp;&emsp;&ensp;访存(MEM)：对存储器进行读写操作。
&emsp;&emsp;&ensp;写回(WB)：将指令执行结果写回寄存器组。

![Alt text](image-15.png)

### 指令流水段的功能

#### Ifetch(IF)段

&emsp;&emsp;&ensp;IF流水段的功能是:将PC的值作为地址到取指部件中取指令，同时需要对PC进行自增操作，新PC的值送PC输 入端。这些功能由取指部件来完成。
&emsp;&emsp;&ensp;IF段执行的结果被送到IF/ID段寄存器的输入端，下一个时钟到来时，在IF/ID寄存器输入端的信息开始送到ID段继续被处理。
&emsp;&emsp;&ensp;这些结果分别是：

1. 从取指部件中取出的指令。
2. 如果当前指令是分支指令，则分支指令的返回地址也需要保存在IF/ID寄存器中。

![Alt text](image-16.png)

#### Reg/Dec(ID) 段

&emsp;&emsp;&ensp;ID流水段的功能是：

1. 根据指令中的Rs，Rt和Rd的值到寄存器堆中取出相应寄存器的值。
2. 对指令中的操作码op字段进行译码，生成相应的控制信号。

&emsp;&emsp;&ensp;ID段执行的结果被送到ID/Ex寄存器的输入端，下一个时钟到来时，在ID/Ex寄存器输入端的信息开始送到Ex段继续被处理。因为指令中需要的信息已被保存，所以指令本身就不再需要保存。

![Alt text](image-17.png)



## 数据旁路技术